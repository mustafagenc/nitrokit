#!/bin/sh
# .husky/pre-commit

echo 'ğŸš€ Checking if pre-commit validation is needed...'

BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_BRANCHES=("main" "preview")
DEVELOPMENT_BRANCHES=("develop" "staging" "testing")

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

VALIDATION_LEVEL="none"

for protected_branch in "${PROTECTED_BRANCHES[@]}"; do
    if [[ "$BRANCH" == "$protected_branch" ]]; then
        VALIDATION_LEVEL="full"
        break
    fi
done

if [[ "$VALIDATION_LEVEL" == "none" ]]; then
    for dev_branch in "${DEVELOPMENT_BRANCHES[@]}"; do
        if [[ "$BRANCH" == "$dev_branch" ]]; then
            VALIDATION_LEVEL="basic"
            break
        fi
    done
fi

if [[ "$VALIDATION_LEVEL" == "none" ]]; then
    echo "ğŸŸ¡ Skipping pre-commit checks for feature branch: $BRANCH"
    echo "ğŸ’¡ Basic checks run on: ${DEVELOPMENT_BRANCHES[*]}"
    echo "ğŸ”’ Full checks run on: ${PROTECTED_BRANCHES[*]}"
    exit 0
fi

if [[ "$VALIDATION_LEVEL" == "full" ]]; then
    echo "ğŸ”’ Running FULL validation for protected branch: $BRANCH"
elif [[ "$VALIDATION_LEVEL" == "basic" ]]; then
    echo "ğŸ› ï¸  Running BASIC validation for development branch: $BRANCH"
fi

run_with_bypass() {
    local command="$1"
    local error_message="$2"
    
    echo "${BLUE}Running: $command${NC}"
    
    if ! yarn --ignore-engines run $command; then
        echo "${RED}$error_message${NC}"
        exit 1
    fi
}

command_exists() {
    yarn --ignore-engines run --help | grep -q "$1" 2>/dev/null
}

echo "${YELLOW}ğŸ¨ Checking code formatting...${NC}"
if command_exists "format:check"; then
    run_with_bypass "format:check" "Prettier Check Failed. Run 'yarn format:write', add changes and try commit again. âŒ"
else
    echo "${YELLOW}âš ï¸  format:check script not found, skipping...${NC}"
fi

echo "${YELLOW}ğŸ“ Checking TypeScript...${NC}"
if command_exists "type-check" || command_exists "tsc"; then
    if command_exists "type-check"; then
        run_with_bypass "type-check" "TypeScript Check Failed. Make the changes required above. âŒ"
    else
        run_with_bypass "tsc" "TypeScript Check Failed. Make the changes required above. âŒ"
    fi
else
    echo "${YELLOW}âš ï¸  TypeScript check script not found, skipping...${NC}"
fi

if [[ "$VALIDATION_LEVEL" == "full" ]]; then
    echo "${YELLOW}ğŸ” Running ESLint (full validation)...${NC}"
    if command_exists "lint"; then
        run_with_bypass "lint" "ESLint Check Failed. Make the required changes listed above, add changes and try to commit again. âŒ"
    else
        echo "${YELLOW}âš ï¸  lint script not found, skipping...${NC}"
    fi

    echo "${YELLOW}ğŸ—ï¸  Building project (full validation)...${NC}"
    if command_exists "build"; then
        run_with_bypass "build" "Next build failed: View the errors above to see why. âŒ"
    else
        echo "${YELLOW}âš ï¸  build script not found, skipping...${NC}"
    fi

    echo "${YELLOW}ğŸ§ª Running tests (full validation)...${NC}"
    if command_exists "test"; then
        run_with_bypass "test" "Tests failed. Fix the failing tests and try again. âŒ"
    else
        echo "${YELLOW}âš ï¸  test script not found, skipping...${NC}"
    fi
fi

echo "${GREEN}âœ… All checks passed for branch: $BRANCH! Committing now.${NC}"